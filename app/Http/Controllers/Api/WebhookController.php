<?php

namespace App\Http\Controllers\Api;

use Log;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Models\StallOP;
use Illuminate\Support\Facades\Http;

class WebhookController extends Controller
{

    private $apiEndpoint;

    public function __construct()
    {
        if (app()->environment('local', 'staging')) {
            $this->apiEndpoint = config('services.pops_url_staging');
        } else {
            $this->apiEndpoint = config('services.pops_url');
        }
    }

    public function receiver(Request $request)
    {
        try {
            $data = $request->all();
            $opDetails = $data[0] ?? null;

            if (!$opDetails) {
                Log::warning('Webhook missing data.');
                return response()->json(['error' => 'Invalid payload'], 400);
            }

            // Combine OR number
            $orNumber = ($opDetails['afnum'] ?? '') . ($opDetails['afext'] ?? '');

            // Convert issuedate string (e.g. "11/4/2025 3:00:10 PM") to proper Y-m-d format
            $orDate = \Carbon\Carbon::createFromFormat('n/j/Y g:i:s A', $opDetails['issuedate'])->format('Y-m-d');

            // Update StallOP record
            StallOP::where('OPRefId', $opDetails['oprefid'])
                ->update([
                    'ORNum'  => $orNumber,
                    'ORDate' => $orDate,
                ]);

            return response()->json(['status' => 'received'], 200);

        } catch (\Throwable $th) {
            // Log errors properly
            Log::error('Webhook processing failed', [
                'error' => $th->getMessage(),
                'line'  => $th->getLine(),
                'file'  => $th->getFile(),
            ]);

            return response()->json(['status' => 'error', 'message' => $th->getMessage()], 500);
        }
    }

    public function subscribe(Request $request)
    {
        $accountcodes = [
            "40202140-20-72-1",
            "40202140-20-72-37",
            "40202140-20-71-37",
            "40202140-20-78-37",
            "40202140-20-73-37",
            "40202140-20-79-37",
            "40202140-20-77-37",
            "40202140-20-75-37",
            "40202140-20-74-37",
            "40202150-20-82-12",
            "40202150-20-83-12",
            "40202150-20-82-11",
            "40202150-20-83-11",
            "40202150-20-82-10",
            "40202150-20-83-10",
            "40202150-20-82-9",
            "40202150-20-83-9",
            "40202150-20-82-3",
            "40202150-20-83-3",
            "40202140-20-78-30",
            "40202140-20-79-30",
            "40202140-20-77-30",
            "40202140-20-72-30",
            "40202140-20-71-30",
            "40202140-20-73-30",
            "40202140-20-75-30",
            "40202140-20-74-30",
            "40202150-20-82-4",
            "40202150-20-83-4",
            "40202140-20-72-31",
            "40202140-20-71-31",
            "40202140-20-73-31",
            "40202140-20-75-31",
            "40202140-20-74-31",
            "40202140-20-72-32",
            "40202140-20-71-32",
            "40202140-20-73-32",
            "40202140-20-75-32",
            "40202140-20-74-32",
            "40202140-20-78-31",
            "40202140-20-79-31",
            "40202140-20-77-31",
            "40202140-20-78-32",
            "40202140-20-79-32",
            "40202140-20-77-32",
            "29999990-20-72-1",
            "29999990-20-71-1",
            "29999990-20-78-1",
            "29999990-20-73-1",
            "29999990-20-79-1",
            "29999990-20-77-1",
            "29999990-20-75-1",
            "29999990-20-74-1",
            "40202150-20-82-7",
            "40202150-20-83-7",
            "40202140-20-72-46",
            "40202140-20-71-46",
            "40202140-20-78-46",
            "40202140-20-73-46",
            "40202140-20-79-46",
            "40202140-20-77-46",
            "40202140-20-75-46",
            "40202140-20-74-46",
            "40202150-20-82-1",
            "40202150-20-83-1",
            "40202150-20-82-8",
            "40202150-20-83-8",
            "40202140-20-71-40",
            "40202140-20-72-39",
            "40202140-20-71-39",
            "40202140-20-78-39",
            "40202140-20-73-39",
            "40202140-20-79-39",
            "40202140-20-77-39",
            "40202140-20-75-39",
            "40202140-20-74-39",
            "40202140-20-71-42",
            "40202140-20-71-41",
            "40202140-20-72-44",
            "40202140-20-71-44",
            "40202140-20-78-44",
            "40202140-20-73-44",
            "40202140-20-79-44",
            "40202140-20-77-44",
            "40202140-20-75-44",
            "40202140-20-74-44",
            "40202140-20-72-45",
            "40202140-20-71-45",
            "40202140-20-78-45",
            "40202140-20-73-45",
            "40202140-20-79-45",
            "40202140-20-77-45",
            "40202140-20-75-45",
            "40202140-20-74-45",
            "40202140-20-72-43",
            "40202140-20-73-43",
            "40202140-20-75-43",
            "40202140-20-74-43",
            "40202140-20-72-42",
            "40202140-20-78-42",
            "40202140-20-73-42",
            "40202140-20-79-42",
            "40202140-20-77-42",
            "40202140-20-75-42",
            "40202140-20-74-42",
            "40202140-20-78-43",
            "40202140-20-79-43",
            "40202140-20-77-43",
            "40202140-20-78-11",
            "40202140-20-77-11",
            "40202140-20-78-25",
            "40202140-20-79-25",
            "40202140-20-77-25",
            "40202140-20-72-17",
            "40202140-20-71-17",
            "40202140-20-73-17",
            "40202140-20-75-17",
            "40202140-20-74-17",
            "40202140-20-78-3",
            "40202140-20-79-3",
            "40202140-20-77-3",
            "40202140-20-78-17",
            "40202140-20-79-17",
            "40202140-20-77-17",
            "40202140-20-78-8",
            "40202140-20-79-8",
            "40202140-20-77-8",
            "40202140-20-78-22",
            "40202140-20-79-22",
            "40202140-20-77-22",
            "40202140-20-79-12",
            "40202140-20-77-12",
            "40202140-20-78-26",
            "40202140-20-77-26",
            "40202140-20-72-16",
            "40202140-20-71-16",
            "40202140-20-73-16",
            "40202140-20-74-16",
            "40202140-20-75-16",
            "40202140-20-78-2",
            "40202140-20-79-2",
            "40202140-20-77-2",
            "40202140-20-78-16",
            "40202140-20-79-16",
            "40202140-20-77-16",
            "40202140-20-72-20",
            "40202140-20-73-20",
            "40202140-20-75-20",
            "40202140-20-74-20",
            "40202140-20-78-6",
            "40202140-20-79-6",
            "40202140-20-77-6",
            "40202140-20-78-20",
            "40202140-20-79-20",
            "40202140-20-77-20",
            "40202140-20-78-5",
            "40202140-20-79-5",
            "40202140-20-77-5",
            "40202140-20-72-19",
            "40202140-20-71-19",
            "40202140-20-73-19",
            "40202140-20-75-19",
            "40202140-20-74-19",
            "40202140-20-78-19",
            "40202140-20-79-19",
            "40202140-20-77-19",
            "40202140-20-72-13",
            "40202140-20-71-13",
            "40202140-20-73-13",
            "40202140-20-75-13",
            "40202140-20-74-13",
            "40202140-20-79-27",
            "40202140-20-78-13",
            "40202140-20-79-13",
            "40202140-20-77-13",
            "40202140-20-78-27",
            "40202140-20-77-27",
            "40202140-20-78-10",
            "40202140-20-79-10",
            "40202140-20-77-10",
            "40202140-20-78-24",
            "40202140-20-79-24",
            "40202140-20-77-24",
            "40202140-20-73-14",
            "40202140-20-74-14",
            "40202140-20-71-14",
            "40202140-20-72-14",
            "40202140-20-78-14",
            "40202140-20-79-14",
            "40202140-20-77-14",
            "40202140-20-78-28",
            "40202140-20-79-28",
            "40202140-20-77-28",
            "40202140-20-78-9",
            "40202140-20-79-9",
            "40202140-20-77-9",
            "40202140-20-78-23",
            "40202140-20-79-23",
            "40202140-20-77-23",
            "40202140-20-71-15",
            "40202140-20-78-1",
            "40202140-20-79-1",
            "40202140-20-77-1",
            "40202140-20-78-15",
            "40202140-20-79-15",
            "40202140-20-77-15",
            "40202140-20-78-7",
            "40202140-20-79-7",
            "40202140-20-77-7",
            "40202140-20-78-21",
            "40202140-20-79-21",
            "40202140-20-77-21",
            "40202140-20-71-18",
            "40202140-20-73-18",
            "40202140-20-75-18",
            "40202140-20-74-18",
            "40202140-20-78-4",
            "40202140-20-79-4",
            "40202140-20-77-4",
            "40202140-20-78-18",
            "40202140-20-79-18",
            "40202140-20-77-18",
            "40202140-20-78-12",
            "40202140-20-79-26",
            "40202140-20-71-20",
            "40202140-20-75-14",
            "40202140-20-72-18",
            "40202140-20-72-25",
            "40202140-20-71-25",
            "40202140-20-73-25",
            "40202140-20-75-25",
            "40202140-20-74-25",
            "40202140-20-72-26",
            "40202140-20-73-26",
            "40202140-20-75-26",
            "40202140-20-74-26",
            "40202140-20-71-26",
            "40202140-20-72-27",
            "40202140-20-71-27",
            "40202140-20-73-27",
            "40202140-20-75-27",
            "40202140-20-74-27",
            "40202140-20-72-24",
            "40202140-20-73-24",
            "40202140-20-75-24",
            "40202140-20-74-24",
            "40202140-20-72-28",
            "40202140-20-71-28",
            "40202140-20-73-28",
            "40202140-20-75-28",
            "40202140-20-74-28",
            "40202140-20-72-11",
            "40202140-20-71-11",
            "40202140-20-73-11",
            "40202140-20-75-11",
            "40202140-20-74-11",
            "40202140-20-72-3",
            "40202140-20-71-3",
            "40202140-20-73-3",
            "40202140-20-75-3",
            "40202140-20-74-3",
            "40202140-20-72-22",
            "40202140-20-71-22",
            "40202140-20-73-22",
            "40202140-20-75-22",
            "40202140-20-74-22",
            "40202140-20-72-8",
            "40202140-20-71-8",
            "40202140-20-73-8",
            "40202140-20-75-8",
            "40202140-20-74-8",
            "40202140-20-72-12",
            "40202140-20-71-12",
            "40202140-20-73-12",
            "40202140-20-75-12",
            "40202140-20-74-12",
            "40202140-20-72-2",
            "40202140-20-71-2",
            "40202140-20-73-2",
            "40202140-20-75-2",
            "40202140-20-74-2",
            "40202140-20-72-6",
            "40202140-20-71-6",
            "40202140-20-73-6",
            "40202140-20-75-6",
            "40202140-20-74-6",
            "40202140-20-72-5",
            "40202140-20-71-5",
            "40202140-20-73-5",
            "40202140-20-75-5",
            "40202140-20-74-5",
            "40202140-20-71-24",
            "40202140-20-72-10",
            "40202140-20-71-10",
            "40202140-20-73-10",
            "40202140-20-75-10",
            "40202140-20-74-10",
            "40202140-20-72-23",
            "40202140-20-71-23",
            "40202140-20-73-23",
            "40202140-20-75-23",
            "40202140-20-74-23",
            "40202140-20-72-9",
            "40202140-20-71-9",
            "40202140-20-73-9",
            "40202140-20-75-9",
            "40202140-20-74-9",
            "40202140-20-71-1",
            "40202140-20-73-1",
            "40202140-20-75-1",
            "40202140-20-74-1",
            "40202140-20-72-15",
            "40202140-20-73-15",
            "40202140-20-75-15",
            "40202140-20-74-15",
            "40202140-20-72-21",
            "40202140-20-71-21",
            "40202140-20-73-21",
            "40202140-20-75-21",
            "40202140-20-74-21",
            "40202140-20-72-7",
            "40202140-20-71-7",
            "40202140-20-73-7",
            "40202140-20-75-7",
            "40202140-20-74-7",
            "40202140-20-72-4",
            "40202140-20-71-4",
            "40202140-20-73-4",
            "40202140-20-75-4",
            "40202140-20-74-4",
            "40202140-20-75",
            "40202140-20-72-51",
            "40202140-20-71-51",
            "40202140-20-78-51",
            "40202140-20-73-51",
            "40202140-20-79-51",
            "40202140-20-77-51",
            "40202140-20-75-51",
            "40202140-20-74-51",
            "40202140-20-72-50",
            "40202140-20-71-50",
            "40202140-20-78-50",
            "40202140-20-73-50",
            "40202140-20-79-50",
            "40202140-20-77-50",
            "40202140-20-75-50",
            "40202140-20-74-50",
            "40202140-20-72-41",
            "40202140-20-73-41",
            "40202140-20-78-41",
            "40202140-20-79-41",
            "40202140-20-77-41",
            "40202140-20-75-41",
            "40202140-20-74-41",
            "40202140-20-72-49",
            "40202140-20-71-49",
            "40202140-20-78-49",
            "40202140-20-73-49",
            "40202140-20-79-49",
            "40202140-20-77-49",
            "40202140-20-75-49",
            "40202140-20-74-49",
            "40202140-20-72-48",
            "40202140-20-71-48",
            "40202140-20-78-48",
            "40202140-20-73-48",
            "40202140-20-79-48",
            "40202140-20-77-48",
            "40202140-20-75-48",
            "40202140-20-74-48",
            "40202140-20-72-40",
            "40202140-20-78-40",
            "40202140-20-73-40",
            "40202140-20-79-40",
            "40202140-20-77-40",
            "40202140-20-75-40",
            "40202140-20-74-40",
            "20401050-20-72-2",
            "20401050-20-71-2",
            "20401050-20-73-2",
            "20401050-20-75-2",
            "20401050-20-74-2",
            "20401050-20-72-1",
            "20401050-20-71-1",
            "20401050-20-75-1",
            "20401050-20-74-1",
            "40202140-20-72-47",
            "40202140-20-71-47",
            "40202140-20-78-47",
            "40202140-20-73-47",
            "40202140-20-79-47",
            "40202140-20-77-47",
            "40202140-20-75-47",
            "40202140-20-74-47",
            "40202140-20-72-33",
            "40202140-20-73-33",
            "40202140-20-75-33",
            "40202140-20-74-33",
            "40202140-20-72-34",
            "40202140-20-73-34",
            "40202140-20-75-34",
            "40202140-20-74-34",
            "40202150-20-82-5",
            "40202150-20-83-5",
            "40202140-20-71-34",
            "40202140-20-78-33",
            "40202140-20-79-33",
            "40202140-20-77-33",
            "40202140-20-78-34",
            "40202140-20-79-34",
            "40202140-20-77-34",
            "40202140-20-71-33",
            "40202140-20-71-43",
            "40202160-20-14-4",
            "40202140-20-72-36",
            "40202140-20-71-36",
            "40202140-20-78-36",
            "40202140-20-73-36",
            "40202140-20-79-36",
            "40202140-20-77-36",
            "40202140-20-75-36",
            "40202140-20-74-36",
            "40202150-20-82-2",
            "40202150-20-83-2",
            "40202140-20-72-38",
            "40202140-20-71-38",
            "40202140-20-78-38",
            "40202140-20-73-38",
            "40202140-20-79-38",
            "40202140-20-77-38",
            "40202140-20-75-38",
            "40202140-20-74-38",
            "40202140-20-72-29",
            "40202140-20-71-29",
            "40202140-20-73-29",
            "40202140-20-75-29",
            "40202140-20-74-29",
            "40202140-20-78-29",
            "40202140-20-79-29",
            "40202140-20-77-29",
            "40202140-20-72-35",
            "40202140-20-78-35",
            "40202140-20-73-35",
            "40202140-20-79-35",
            "40202140-20-77-35",
            "40202140-20-75-35",
            "40202140-20-74-35",
            "40202140-20-71-35",
            "40202150-20-82-6",
            "40202150-20-83-6",
            "29999990-20-71-2",
            "29999990-20-72-2",
            "29999990-20-78-2",
            "29999990-20-73-2",
            "29999990-20-79-2",
            "29999990-20-77-2",
            "29999990-20-75-2",
            "29999990-20-74-2",
        ];

        $callbackUrl = 'http://192.168.61.141/api/webhook/receiver';
        $subscribeUrl = "{$this->apiEndpoint}/webhook/subscribe";

        foreach ($accountcodes as $accountcode) {
            $response = Http::get($subscribeUrl, [
                'accountcode' => $accountcode,
                'callbackurl' => $callbackUrl
            ]);

            // check for failed requests
            if (!$response->successful()) {
                Log::warning("Subscription failed for accountcode: {$accountcode}", [
                    'response' => $response->body()
                ]);
            }
        }

        return response()->json(['status' => 'subscribed'], 200);
    }
}
